steps:
# - name: 'gcr.io/k8s-skaffold/skaffold'
#   id: 'build-images'
#   args: ['build']
#   waitFor: ['-']
# - name: 'gcr.io/k8s-skaffold/skaffold'
#   id: 'build-images'
#   args: ['render']
#   waitFor: ['-']
# - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
#   id: 'scan'
#   waitFor: ['-']
#   entrypoint: "bash"
#   args:
#   - '-c'
#   - |
#     gcloud beta artifacts docker images scan $_IMAGE
- name: '$_IMAGE'
  id: 'test-frontend'
  waitFor: ['-']
  entrypoint: 'go'
  args: ['test', 'cmd/frontend']
- name: '$_IMAGE'
  id: 'test-backend'
  waitFor: ['-']
  entrypoint: 'go'
  args: ['test', 'cmd/backend']
# - name: 'gcr.io/$PROJECT_ID/kustomize'
#   id: 'create-production-yaml'
#   waitFor: ['test-frontend', 'test-backend']
#   entrypoint: 'sh'
#   args:
#   - -c
#   - |
#      /kustomize build k8s/production > production.yaml
# - name: 'gcr.io/cloud-builders/gsutil'
#   id: 'upload-production-yaml'
#   waitFor: ['create-production-yaml']
#   args:
#   - cp
#   - production.yaml
#   - gs://vic-cd-demo-k8s-yaml/production.yaml
# - name: 'gcr.io/$PROJECT_ID/kustomize'
#   id: 'create-staging-yaml'
#   waitFor: ['test-frontend', 'test-backend']
#   entrypoint: 'sh'
#   args:
#   - -c
#   - |
#      /kustomize build k8s/staging > staging.yaml
# - name: 'gcr.io/cloud-builders/gsutil'
#   id: 'upload-staging-yaml'
#   waitFor: ['create-staging-yaml']
#   args:
#   - cp
#   - staging.yaml
#   - gs://vic-cd-demo-k8s-yaml/staging.yaml
# images:
# - 'gcr.io/$PROJECT_ID/sample-app-frontend:$COMMIT_SHA'
# - 'gcr.io/$PROJECT_ID/sample-app-backend:$COMMIT_SHA'
